<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/favicon.ico"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
    <meta name="theme-color" content="#7c3aed"/>
    <meta name="description" content="The Nest - Chore and task tracking platform"/>
    <link rel="apple-touch-icon" href="/TheNestLogo.png"/>
    <link rel="manifest" href="/manifest.json"/>
    <title>The Nest - Task Tracking</title>
    
    <!-- PWA Error Recovery Script -->
    <script>
        // Global error handler for PWA
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            // Attempt recovery after critical errors
            if (e.error && e.error.message) {
                setTimeout(() => {
                    if (confirm('The app encountered an error. Would you like to try to recover?')) {
                        window.location.reload();
                    }
                }, 1000);
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                        
                        // Check for service worker updates
                        registration.addEventListener('updatefound', function() {
                            console.log('New service worker found');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker is available, show update prompt
                                    if (confirm('A new version of the app is available. Would you like to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // PWA specific error handling
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running in PWA mode');
            
            // Add PWA-specific error recovery
            let errorCount = 0;
            const maxErrors = 3;
            
            window.addEventListener('error', function() {
                errorCount++;
                if (errorCount >= maxErrors) {
                    console.log('Too many errors in PWA mode, attempting recovery');
                    // Clear caches and reload
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            names.forEach(function(name) {
                                caches.delete(name);
                            });
                        });
                    }
                    setTimeout(() => window.location.reload(), 1000);
                }
            });
        }

        // Network status monitoring
        window.addEventListener('online', function() {
            console.log('App is online');
            document.body.classList.remove('offline');
        });

        window.addEventListener('offline', function() {
            console.log('App is offline');
            document.body.classList.add('offline');
        });

        // App initialization timeout handler
        let appInitialized = false;
        setTimeout(function() {
            if (!appInitialized) {
                console.error('App initialization timeout');
                if (confirm('The app is taking too long to load. Would you like to try again?')) {
                    window.location.reload();
                }
            }
        }, 10000); // 10 second timeout
    </script>
    
    <style>
        /* Loading and error styles */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #root {
            min-height: 100vh;
        }

        .offline {
            background-color: #1e1b4b !important;
        }

        .offline::before {
            content: "Offline - Some features may not be available";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            z-index: 9999;
        }

        /* Critical error fallback */
        .critical-error {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1e1b4b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            text-align: center;
            z-index: 10000;
        }

        .critical-error h1 {
            color: #fbbf24;
            margin-bottom: 20px;
        }

        .critical-error button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- Critical error fallback -->
    <div id="critical-error" class="critical-error" style="display: none;">
        <h1>The Nest</h1>
        <h2>App Failed to Load</h2>
        <p>We're sorry, but the app encountered a critical error.</p>
        <button onclick="window.location.reload()">Try Again</button>
        <button onclick="clearAppData()">Clear Data & Reload</button>
    </div>

    <script>
        // Clear app data function
        function clearAppData() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        return Promise.all(names.map(function(name) {
                            return caches.delete(name);
                        }));
                    });
                }
                window.location.reload();
            } catch (e) {
                console.error('Failed to clear app data:', e);
                window.location.reload();
            }
        }

        // Mark app as initialized when React loads
        window.addEventListener('load', function() {
            setTimeout(function() {
                appInitialized = true;
            }, 2000);
        });
    </script>
</body>
</html>
